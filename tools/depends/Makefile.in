#include Makefile.include

BUILDTOOLS = m4-native help2man-native gettext-native autoconf-native automake-native libtool-native pkg-config-native yasm-native cmake-native gas-preprocessor-native

SUBDIRS = \
	ncurses pcre expat gettext readline sqlite3 libgpg-error \
	libgcrypt bzip2 liblzo2 libzip freetype2 fontconfig \
	openssl libssh2 curl \
	libjpeg-turbo tiff jasper libpng \
	libogg libvorbis libflac libmad fribidi libmpeg2 \
	libass libsamplerate \
	libmodplug librtmp libxml2 yajl libmicrohttpd mysql libffi \
	python26-native python26 samba libcdio afpfs-ng libshairport \
	libplist libcec libbluray boost tinyxml dummy-libxbmc libsdl-native \
	liblzo2-native libjpeg-turbo-native libpng-native tiff-native libsdl_image-native rpl-native \
	libamplayer libssh taglib swig-native pcre-native xbmc-pvr-addons libusb libnfs

ifeq (@platform_os@,ios)
  EXCLUDED = libcec libcrystalhd libusb
endif

ifeq (@platform_os@,osx)
  EXCLUDED = libusb
endif

SUBDIRS := $(filter-out $(EXCLUDED),$(SUBDIRS))

ZLIB=
ifneq (@has_zlib@,1)
  SUBDIRS += zlib
  ZLIB = zlib
endif

ICONV=
ifeq (@need_libiconv@,1)
  SUBDIRS += libiconv
  ICONV = libiconv
endif

ALSA_LIB=
ifeq (@platform_os@,linux)
  SUBDIRS += alsa-lib
  ALSA_LIB = alsa-lib
endif

.PHONY: buildtools $(BUILDTOOLS) subdirs $(SUBDIRS)

all: subdirs
	@echo "Dependencies built successfully."

# Dependency layout for parallel builds
autoconf-native: m4-native
help2man-native: autoconf-native gettext-native
automake-native: autoconf-native
libtool-native: automake-native
gettext: $(ICONV) ncurses
libgcrypt: libgpg-error
fontconfig: freetype2 expat $(ICONV)
libssh2: libgcrypt openssl rpl-native
curl: openssl libssh2 rpl-native
tiff: libjpeg-turbo
jasper: libjpeg-turbo
libvorbis: libogg rpl-native
libflac: libogg gettext rpl-native
libass: fontconfig libpng freetype2 expat $(ICONV) rpl-native
librtmp: openssl rpl-native
libxml2: $(ICONV)
libmicrohttpd: openssl libgpg-error libgcrypt
python26: python26-native expat gettext libxml2 sqlite3 openssl libffi
libcdio: $(ICONV)
afpfs-ng: libgcrypt readline $(ICONV) rpl-native
libshairport: openssl rpl-native
libplist: libxml2 cmake-native
libbluray: $(ICONV) libxml2 rpl-native
yajl: cmake-native
libsdl_image-native: buildtools libsdl-native libjpeg-turbo-native libpng-native tiff-native
python26-native: buildtools
libsdl-native: buildtools
$(ALSA_LIB): rpl-native
libcec: rpl-native
libmad: rpl-native
libmodplug: rpl-native
libmpeg2: rpl-native
libogg: rpl-native
rpl-native: python26-native
libjpeg-turbo-native: buildtools
libpng-native: buildtools
tiff-native: buildtools libjpeg-turbo-native 
liblzo2-native: buildtools
libssh: openssl cmake-native rpl-native
taglib: cmake-native
swig-native: buildtools pcre-native
pcre-native: buildtools
libnfs: rpl-native
xbmc-pvr-addons: boost mysql
mysql: readline openssl
libzip: $(ZLIB)

buildtools: $(BUILDTOOLS)
$(BUILDTOOLS):
	$(MAKE) -C $@

subdirs: $(SUBDIRS)
$(SUBDIRS): $(filter-out cmake-native,$(BUILDTOOLS))
	$(MAKE) -C $@

clean:
	for d in $(BUILDTOOLS); do $(MAKE) -C $$d clean; done
	for d in $(SUBDIRS); do $(MAKE) -C $$d clean; done

distclean::
	for d in $(BUILDTOOLS); do $(MAKE) -C $$d distclean; done
	for d in $(SUBDIRS); do $(MAKE) -C $$d distclean; done

